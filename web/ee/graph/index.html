<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>RopeDB Visualizer</title>
<style>
  *{box-sizing:border-box}
  html,body{margin:0;height:100vh;scrollbar-gutter:stable both-edges}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:grid;grid-template-columns:60% 40%;grid-template-rows:60% 40%;
    gap:10px;background:#f5f5f5;padding:10px
  }
  #graph,#search,#legend,#info{background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);overflow:hidden}
  #graph{grid-column:1;grid-row:1;overflow:hidden;overscroll-behavior:contain}
  #search{grid-column:2;grid-row:1;padding:16px}
  #info{grid-column:1;grid-row:2;padding:16px}
  #legend{grid-column:2;grid-row:2;padding:16px}
  #f{width:100%;height:100%;border:0;overflow:hidden;display:block}
  .sec h3{margin:0 0 10px 0;font-size:14px;color:#333}
  .row{margin-bottom:12px}
  input[type=text]{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px}
  button{margin-top:6px;width:100%;padding:10px;border:0;border-radius:8px;cursor:pointer;background:#2f6fed;color:#fff;font-weight:600}
  button.green{background:#28a745}
  .legend-item{display:flex;align-items:center;margin-bottom:6px}
  .legend-color{width:16px;height:16px;border-radius:3px;margin-right:8px}
  .kv{font-size:12px;color:#555}.kv b{color:#222}.muted{color:#888;font-size:12px}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  #info .kv{font-size:15px;font-weight:600;color:#333}
  #info .kv b{color:#111;font-weight:700}
  #info .muted{color:#666;font-size:13px;font-weight:500}
  #info .mono{font-weight:600}
  #info .sec h3{font-size:16px;font-weight:700;color:#222}
</style>
</head>
<body>
  <section id="graph"><iframe id="f" src="/ui/ee/graph/frame" scrolling="no"></iframe></section>

  <section id="search" style="max-height: 90vh; overflow-y: auto; padding-right: 8px;">
    <div class="sec">
      <h3>ğŸ” Address Search</h3>
      <div class="row"><input id="addr" type="text" placeholder="0x1234..."/></div>
      <button id="addrBtn">Search Address + 1-hop</button>
    </div>
    <div class="sec" style="margin-top:14px">
      <h3>ğŸ§µ Rope Search</h3>
      <div class="row"><input id="rope" type="text" placeholder="Rope ID (e.g. 1, 2, 3)"/></div>
      <button id="ropeBtn">Search Rope Members + 1-hop</button>
    </div>
    <button id="defBtn" class="green" style="margin-top:14px">ğŸ  Default View</button>
  </section>

  <section id="legend"  style="overflow-y: auto;">
    <div class="sec"><h3>ğŸ¨ Trait Colors</h3><div id="traitLegend"></div></div>
    <div class="sec" style="margin-top:10px"><h3>ğŸ§µ Rope Colors</h3><div id="ropeLegend"></div></div>
  </section>

  <section id="info" style="overflow-y:auto;">
    <div class="sec">
      <h3>â„¹ï¸ Info</h3>
      <div id="stat" class="kv">
        Nodes: <b id="sn">0</b> | Edges: <b id="se">0</b><br/>
        Type: <b id="st">-</b><br/>
        Start: <span id="ss" class="mono muted">-</span>
      </div>
    </div>
    <div class="sec" style="margin-top:10px">
      <h3>Node</h3>
      <div id="nodeBox" class="kv muted">Hover a nodeâ€¦</div>
    </div>
    <div class="sec" style="margin-top:10px">
      <h3>Edge</h3>
      <div id="edgeBox" class="kv muted">Hover an edgeâ€¦</div>
    </div>
  </section>

<script>
const f = document.getElementById('f');
const sn=document.getElementById('sn'), se=document.getElementById('se'), st=document.getElementById('st'), ss=document.getElementById('ss');
const nodeBox=document.getElementById('nodeBox'), edgeBox=document.getElementById('edgeBox');
let CURRENT = { meta:{}, nodes:[], edges:[], legend:{traits:{}, ropes:{}} };

function syncStats(g){
  sn.textContent = String(g.meta?.nodeCount || (g.nodes?g.nodes.length:0) || 0);
  se.textContent = String(g.meta?.edgeCount || (g.edges?g.edges.length:0) || 0);
  st.textContent = g.meta?.graphType || '-';
  ss.textContent = g.meta?.startNode || '-';
}
// mergeGraph() í•¨ìˆ˜ ì œê±°: ìˆœìˆ˜ DB ê¸°ë°˜ ì•„í‚¤í…ì²˜ì—ì„œëŠ” ë¸Œë¼ìš°ì € ìƒíƒœ ë³‘í•©ì´ ë¶ˆí•„ìš”í•¨
// ëª¨ë“  ê·¸ë˜í”„ ì‘ì—…ì€ ë‹¨ì¼ DB ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ì§ì ‘ ì‚¬ìš©
function renderLegend(legend){
  const t = document.getElementById('traitLegend'), r = document.getElementById('ropeLegend');
  t.innerHTML = ''; r.innerHTML = '';
  
  // í´ë¦­ ê°€ëŠ¥í•œ ë²”ë¡€ í•­ëª© ìƒì„±
  const mk = (color,name,count,traitCode)=>`<div class="legend-item" data-trait="${traitCode||''}" style="cursor:pointer;padding:4px;border-radius:4px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background=''"onclick="toggleTraitHighlight('${traitCode||''}','${color}')"><div class="legend-color" style="background:${color}"></div><span>${name}</span><span style="margin-left:auto;color:#888;font-size:11px">${count}</span></div>`;
  
  // Multi-Trait í•­ëª©ì„ ë§¨ ìœ„ì— ì¶”ê°€ (ì‹¤ì œ ë©€í‹° íŠ¸ë ˆì´íŠ¸ ì—°ê²°ëœ ë…¸ë“œ ìˆ˜ ê³„ì‚°)
  let multiTraitNodes = new Set();
  // CURRENT ê·¸ë˜í”„ì—ì„œ parallelCount > 1ì¸ ì—£ì§€ë“¤ì˜ ë…¸ë“œë“¤ì„ ìˆ˜ì§‘
  if (CURRENT && CURRENT.edges) {
    CURRENT.edges.forEach(edge => {
      const cnt = edge.parallelCount || 1;
      if (cnt > 1) {
        multiTraitNodes.add(edge.source);
        multiTraitNodes.add(edge.target);
      }
    });
  }
  const multiTraitCount = multiTraitNodes.size;
  t.insertAdjacentHTML('beforeend', mk('#000000', 'Multi-Trait', multiTraitCount, 'multi'));
  
  // ê¸°ì¡´ íŠ¸ë ˆì´íŠ¸ë“¤
  for (const k in (legend.traits||{})) {
    const it = legend.traits[k]; 
    t.insertAdjacentHTML('beforeend', mk(it.color, it.name, it.count||0, k));
  }
  
  for (const k in (legend.ropes||{})) {
    const it = legend.ropes[k]; 
    r.insertAdjacentHTML('beforeend', mk(it.color, it.name, it.count||0));
  }
}

// íŠ¸ë ˆì´íŠ¸ í•˜ì´ë¼ì´íŒ… ê¸°ëŠ¥
let currentHighlightTrait = null;

function toggleTraitHighlight(traitCode, color) {
  if (currentHighlightTrait === traitCode) {
    // ì´ë¯¸ ì„ íƒëœ íŠ¸ë ˆì´íŠ¸ë©´ í•˜ì´ë¼ì´íŒ… í•´ì œ
    currentHighlightTrait = null;
    f.contentWindow.postMessage({type: 'clear-highlight'}, '*');
  } else {
    // ìƒˆë¡œìš´ íŠ¸ë ˆì´íŠ¸ í•˜ì´ë¼ì´íŒ…
    currentHighlightTrait = traitCode;
    f.contentWindow.postMessage({type: 'highlight-trait', payload: {traitCode, color}}, '*');
  }
}

// ë©”ì‹œì§€(ìì‹ â†’ ë¶€ëª¨)
window.addEventListener('message', (ev)=>{
  const msg = ev.data||{};
  if (msg.type==='child-mounted'){
    // ì´ˆê¸° ë¡œë“œ
    fetch('/api/ee/graph/default').then(r=>r.json()).then(g=>{
      CURRENT = g; syncStats(CURRENT); renderLegend(CURRENT.legend||{traits:{},ropes:{}});
      f.contentWindow.postMessage({type:'load-graph', payload: CURRENT}, '*');
    });
  } else if (msg.type==='child-ready'){
    // ok ì—¬ë¶€ë§Œ í™•ì¸ ê°€ëŠ¥
  } else if (msg.type==='node-hover'){
    if (!msg.payload){ nodeBox.textContent='Hover a nodeâ€¦'; nodeBox.classList.add('muted'); return; }
    nodeBox.classList.remove('muted');
    const p = msg.payload;
    
    // ê¸°ë³¸ ì •ë³´
    let html = 'Address: <span class="mono">' + (p.id || '') + '</span>';
    
    // ë¡œí”„ ì •ë³´
    if (p.ropeCount > 0) {
      html += '<br/>Ropes: <b>' + p.ropeCount + '</b>';
      if (p.ropeName && p.ropeName !== 'Unknown') {
        html += ' (Primary: ' + p.ropeName + ')';
      }
    }
    
    // íŠ¸ë ˆì´íŠ¸ ì •ë³´
    if (p.traitCount > 0) {
      html += '<br/>Traits: <b>' + p.traitCount + '</b>';
      if (p.traits && p.traits.length > 0) {
        html += '<br/>Types: ';
        const traitNames = p.traits.slice(0, 3).map(t => t.traitName || 'code ' + t.traitCode).join(', ');
        html += '<span class="muted">' + traitNames;
        if (p.traits.length > 3) {
          html += ' +' + (p.traits.length - 3) + ' more';
        }
        html += '</span>';
      }
    }
    
    // ì •ë³´ê°€ ì—†ì„ ê²½ìš°
    if (p.ropeCount === 0 && p.traitCount === 0) {
      html += '<br/><span class="muted">No connections</span>';
    }
    
    nodeBox.innerHTML = html;
  } else if (msg.type==='edge-hover'){
    if (!msg.payload){ edgeBox.textContent='Hover an edgeâ€¦'; edgeBox.classList.add('muted'); return; }
    edgeBox.classList.remove('muted');
    const p = msg.payload;
    
    if (p.isMultiTrait && p.traits) {
      // ë©€í‹° íŠ¸ë ˆì´íŠ¸ ì •ë³´ í‘œì‹œ
      let html = '<b>Multi-Trait Connection (' + p.totalTraits + ' traits):</b><br/>';
      p.traits.forEach((trait, index) => {
        html += (index > 0 ? '<br/>' : '') + 
                'â€¢ <b>' + (trait.traitName || ('code ' + trait.traitCode)) + '</b> ' +
                '<span class="mono">#' + (trait.traitId || 0) + '</span>';
      });
      edgeBox.innerHTML = html;
    } else {
      // ë‹¨ì¼ íŠ¸ë ˆì´íŠ¸ ì •ë³´ í‘œì‹œ
      edgeBox.innerHTML = 'Trait: <b>'+(p.traitName||('code '+p.traitCode))+'</b> <span class="mono">#'+(p.traitId||0)+'</span>';
    }
  } else if (msg.type==='node-click'){
    const id = msg.payload && msg.payload.id;
    if (!id) return;
    
    // ë…¸ë“œ í™•ì¥ í™•ì¸ ëŒ€í™”ìƒì
    const shortId = id.length > 10 ? id.substr(0, 6) + '..' + id.substr(-4) : id;
    const confirmExpand = confirm(`ë…¸ë“œ "${shortId}"ë¥¼ 1-hop í™•ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì—°ê²°ëœ ë…¸ë“œë“¤ì´ ê·¸ë˜í”„ì— ì¶”ê°€ë©ë‹ˆë‹¤.`);
    
    if (confirmExpand) {
      console.log(`=== NODE EXPANSION (PURE DB MODE): ${shortId} ===`);
      
      fetch('/api/ee/graph/expand?v='+encodeURIComponent(id))
        .then(r=>r.json()).then(expandResult=>{
          console.log('Pure DB expansion result:', {
            nodes: expandResult.nodes?.length || 0,
            edges: expandResult.edges?.length || 0,
            error: expandResult.error
          });
          
          if (expandResult.error) {
            console.error(`Expansion failed: ${expandResult.error}`);
            alert('ë…¸ë“œ í™•ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + expandResult.error);
            return;
          }
          
          // ê¸°ì¡´ ê·¸ë˜í”„ì— í™•ì¥ ê²°ê³¼ ì¶”ê°€ (apply-graph ì‚¬ìš©)
          console.log('Adding expansion results to existing graph');
          const oldCurrent = CURRENT;
          
          // CURRENTì— ìƒˆë¡œìš´ ë…¸ë“œì™€ ì—£ì§€ ì¶”ê°€ (ë¸Œë¼ìš°ì € ìƒíƒœ ë™ê¸°í™”)
          const nodeMap = new Map();
          const edgeMap = new Map();
          
          // ê¸°ì¡´ ë…¸ë“œ/ì—£ì§€ ì¶”ê°€
          (CURRENT.nodes || []).forEach(n => nodeMap.set(n.id, n));
          (CURRENT.edges || []).forEach(e => edgeMap.set(e.id, e));
          
          // í™•ì¥ ê²°ê³¼ ë…¸ë“œ/ì—£ì§€ ì¶”ê°€
          (expandResult.nodes || []).forEach(n => nodeMap.set(n.id, n));
          (expandResult.edges || []).forEach(e => edgeMap.set(e.id, e));
          
          // CURRENT ì—…ë°ì´íŠ¸
          CURRENT.nodes = [...nodeMap.values()];
          CURRENT.edges = [...edgeMap.values()];
          CURRENT.meta = {
            ...CURRENT.meta,
            nodeCount: CURRENT.nodes.length,
            edgeCount: CURRENT.edges.length,
            generatedAt: Math.floor(Date.now()/1000)
          };
          
          // ë²”ë¡€ ì—…ë°ì´íŠ¸ (í™•ì¥ ê²°ê³¼ì— ìƒˆë¡œìš´ ë²”ë¡€ê°€ ìˆë‹¤ë©´)
          if (expandResult.legend) {
            CURRENT.legend = expandResult.legend;
          }
          
          console.log('Graph expansion:', { 
            old: { nodes: oldCurrent.nodes?.length || 0, edges: oldCurrent.edges?.length || 0 },
            added: { nodes: expandResult.nodes?.length || 0, edges: expandResult.edges?.length || 0 },
            new: { nodes: CURRENT.nodes.length, edges: CURRENT.edges.length }
          });
          
          syncStats(CURRENT); 
          renderLegend(CURRENT.legend||{traits:{},ropes:{}});
          f.contentWindow.postMessage({type:'apply-graph', payload: expandResult}, '*');
          console.log(`Pure DB expansion completed: ${shortId} (${CURRENT.nodes?.length || 0} nodes, ${CURRENT.edges?.length || 0} edges)`);
        })
        .catch(err => {
          console.error(`Failed to expand node ${shortId}:`, err);
          alert('ë…¸ë“œ í™•ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    }
  }
});

// ê²€ìƒ‰ ë²„íŠ¼ â†’ ì„œë²„ í˜¸ì¶œ
document.getElementById('defBtn').onclick = ()=>{
  console.log('Default button clicked');
  fetch('/api/ee/graph/default').then(r=>r.json()).then(g=>{
    CURRENT = g; syncStats(CURRENT); renderLegend(CURRENT.legend||{traits:{},ropes:{}});
    f.contentWindow.postMessage({type:'load-graph', payload: CURRENT}, '*');
  });
};

// ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ í™•ì¸
console.log('=== BUTTON EVENT REGISTRATION ===');
console.log('addrBtn element:', document.getElementById('addrBtn'));
console.log('ropeBtn element:', document.getElementById('ropeBtn'));
console.log('defBtn element:', document.getElementById('defBtn'));
console.log('=== EVENT HANDLERS REGISTERED ===');
// ì£¼ì†Œ ê²€ìƒ‰: í•´ë‹¹ ì£¼ì†Œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê·¸ë˜í”„ ì´ˆê¸°í™” + 1-hop í™•ì¥
document.getElementById('addrBtn').onclick = ()=>{
  console.log('=== ADDRESS SEARCH (RESET MODE) ===');
  const addr = (document.getElementById('addr').value||'').trim();
  console.log('Searching address:', addr);
  
  if (!addr) {
    return alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 0x1234...)');
  }
  
  const url = '/api/ee/graph/expand?v='+encodeURIComponent(addr);
  console.log('Request URL:', url);
  
  fetch(url)
    .then(r => r.json())
    .then(searchResult => {
      console.log('Search result:', {
        nodes: searchResult.nodes?.length || 0,
        edges: searchResult.edges?.length || 0,
        error: searchResult.error
      });
      
      if (searchResult.error) {
        alert('ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ' + searchResult.error);
        return;
      }
      
      // ê·¸ë˜í”„ ì™„ì „ ì´ˆê¸°í™” (DB ê²°ê³¼ë¡œ ì™„ì „ ëŒ€ì²´, ë³‘í•© ì—†ìŒ)
      console.log('Replacing current graph with pure DB search results (no merge)');
      CURRENT = searchResult;
      
      // ê·¸ë˜í”„ ë©”íƒ€ ì •ë³´ ì„¤ì •
      CURRENT.meta = {
        ...CURRENT.meta,
        generatedAt: Math.floor(Date.now()/1000),
        graphType: 'search-address',
        startNode: addr
      };
      
      syncStats(CURRENT); 
      renderLegend(CURRENT.legend||{traits:{},ropes:{}});
      
      // iframe ìƒˆë¡œê³ ì¹¨ ì—†ì´ ê·¸ë˜í”„ë§Œ ì™„ì „ ë¦¬ì…‹ í›„ ìƒˆ ë°ì´í„° ë¡œë“œ
      console.log('=== RESETTING GRAPH WITHOUT IFRAME RELOAD ===');
      console.log('New search graph data:', CURRENT);
      
      // load-graph ë©”ì‹œì§€ë¡œ ì™„ì „í•œ ê·¸ë˜í”„ êµì²´ ìˆ˜í–‰
      f.contentWindow.postMessage({type:'load-graph', payload: CURRENT}, '*');
      
      console.log(`Address search completed: ${addr} (${CURRENT.nodes?.length || 0} nodes, ${CURRENT.edges?.length || 0} edges)`);
    })
    .catch(err => {
      console.error('Address search error:', err);
      alert('ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
};

// Rope ê²€ìƒ‰: í•´ë‹¹ Ropeë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê·¸ë˜í”„ ì´ˆê¸°í™” (ì™„ì „íˆ DB ê¸°ë°˜, ë³‘í•© ì—†ìŒ)
document.getElementById('ropeBtn').onclick = ()=>{
  const ropeId = (document.getElementById('rope').value||'').trim();
  if (!ropeId) return alert('Rope IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 1, 2, 3)');
  
  console.log(`=== ROPE SEARCH (PURE DB MODE): ${ropeId} ===`);
  
  // ë‹¨ì¼ DB í˜¸ì¶œ: FetchGraphByRopeIDëŠ” ì´ë¯¸ rope ë©¤ë²„ë“¤ + 1-hop í™•ì¥ì„ DBì—ì„œ ê³„ì‚°í•¨ (depth=2)
  const url = '/api/ee/graph/rope/'+encodeURIComponent(ropeId);
  console.log('Request URL:', url);
  
  fetch(url)
    .then(r => r.json())
    .then(searchResult => {
      console.log('Pure DB rope search result:', {
        nodes: searchResult.nodes?.length || 0,
        edges: searchResult.edges?.length || 0,
        error: searchResult.error
      });
      
      if (searchResult.error) {
        alert('Rope ê²€ìƒ‰ ì‹¤íŒ¨: ' + searchResult.error);
        return;
      }
      
      // ê·¸ë˜í”„ ì™„ì „ ì´ˆê¸°í™” (ìˆœìˆ˜ DB ê²°ê³¼, ë¸Œë¼ìš°ì € ìƒíƒœ ë³‘í•© ì—†ìŒ)
      console.log('Replacing current graph with pure DB rope results (no browser merging)');
      CURRENT = searchResult;
      
      // ê·¸ë˜í”„ ë©”íƒ€ ì •ë³´ ì„¤ì •
      CURRENT.meta = {
        ...CURRENT.meta,
        generatedAt: Math.floor(Date.now()/1000),
        graphType: 'search-rope',
        startNode: `Rope ${ropeId}`
      };
      
      syncStats(CURRENT);
      renderLegend(CURRENT.legend||{traits:{},ropes:{}});
      
      // iframe ìƒˆë¡œê³ ì¹¨ ì—†ì´ ê·¸ë˜í”„ë§Œ ì™„ì „ ë¦¬ì…‹ í›„ ìƒˆ ë°ì´í„° ë¡œë“œ
      console.log('=== RESETTING ROPE GRAPH WITHOUT IFRAME RELOAD ===');
      console.log('Pure DB rope graph data:', CURRENT);
      
      // load-graph ë©”ì‹œì§€ë¡œ ì™„ì „í•œ ê·¸ë˜í”„ êµì²´ ìˆ˜í–‰
      f.contentWindow.postMessage({type:'load-graph', payload: CURRENT}, '*');
      
      console.log(`Pure DB rope search completed: ${ropeId} (${CURRENT.nodes?.length || 0} nodes, ${CURRENT.edges?.length || 0} edges)`);
    })
    .catch(err => {
      console.error('Rope search error:', err);
      alert('Rope ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    });
};
</script>
</body>
</html>
