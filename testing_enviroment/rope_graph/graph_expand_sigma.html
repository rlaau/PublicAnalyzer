<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Expanded Graph</title>
  <style>
    html, body { height: 100%; margin: 0; }
    #container { position: absolute; inset: 0; }
    #toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.92); padding: 8px 10px; border-radius: 10px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Noto Sans, Arial;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    #toolbar code { padding: 2px 6px; background: #eee; border-radius: 6px; }
    #diag {
      position: absolute; right: 10px; bottom: 10px; z-index: 10;
      background: rgba(0,0,0,0.6); color:#fff; padding: 8px 10px; border-radius: 8px;
      font: 12px/1.3 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Noto Sans, Arial;
      white-space: pre-wrap; max-width: 40vw;
    }
  </style>
  <!-- CDN links for libraries -->
  <script src="https://unpkg.com/graphology@0.25.4/dist/graphology.umd.min.js"></script>
  <script src="https://unpkg.com/sigma@2.4.0/build/sigma.min.js"></script>
</head>
<body>
  <div id="toolbar">
    <strong>Expanded Graph</strong>
    <div>nodes: <code id="ncount"></code> | edges: <code id="ecount"></code> | mode: <code id="mode">sigma</code></div>
  </div>
  <div id="container"></div>
  <div id="diag"></div>

  <script>
    // Injected JSON (codes only)
    const DATA = {"meta":{"depth":1,"edgeCount":2,"generatedAt":1755961467,"nodeCount":3,"start":"0x0000000000000000000000000000000000000008"},"users":[{"id":"0x0000000000000000000000000000000000000008","ropes":[{"id":1,"trait_code":100}]},{"id":"0x0000000000000000000000000000000000000007","ropes":[{"id":4,"trait_code":100}]},{"id":"0x0000000000000000000000000000000000000009","ropes":[{"id":1,"trait_code":100}]}],"traits":[{"id":"e:0x0000000000000000000000000000000000000008|0x0000000000000000000000000000000000000009|100|7","a":"0x0000000000000000000000000000000000000008","b":"0x0000000000000000000000000000000000000009","trait_code":100,"trait_id":7,"weight":1,"last_seen":1755961467},{"id":"e:0x0000000000000000000000000000000000000007|0x0000000000000000000000000000000000000008|100|6","a":"0x0000000000000000000000000000000000000008","b":"0x0000000000000000000000000000000000000007","trait_code":100,"trait_id":6,"weight":1,"last_seen":1755961467}],"ropes":[{"id":1,"trait_code":100,"size":8,"volume":7,"last_seen":1755961467},{"id":4,"trait_code":100,"size":0,"volume":0,"last_seen":-62135596800}]};

    const diagEl = document.getElementById('diag');
    const log = (...args) => { console.log(...args); diagEl.textContent += args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' ') + '\\n'; };

    // Safety checks for UMD globals (some builds expose window.Sigma, others window.sigma.Sigma)
    const GraphologyNS = window.graphology || window.Graphology || null;
    const SigmaCtor = (window.Sigma) ? window.Sigma : (window.sigma && window.sigma.Sigma ? window.sigma.Sigma : null);

    if (!GraphologyNS) {
      diagEl.textContent = 'graphology UMD not found (expected window.graphology)\\n';
    }
    if (!SigmaCtor) {
      diagEl.textContent += 'sigma UMD not found (expected window.Sigma or window.sigma.Sigma)\\n';
    }

    try {
      const Graph = GraphologyNS && GraphologyNS.Graph ? GraphologyNS.Graph : null;
      if (!Graph) throw new Error('Graph constructor missing');

      // Programmatic colors
      function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
      function hsl(h,s,l){ return 'hsl('+h+','+s+'%,'+l+'%)'; }
      function colorForNode(id){ const h=hashStr(id)%360, s=55+(hashStr(id+'s')%30), l=45+(hashStr(id+'l')%20); return hsl(h,s,l); }
      const traitPalette = {};
      function colorForTraitCode(tc){ if(!traitPalette[tc]) traitPalette[tc]=hsl((tc%12)*30,70,35); return traitPalette[tc]; }
      function labelColor(bgHsl){
        const m=/hsl\\(\\s*([\\d]+)\\s*,\\s*([\\d]+)%\\s*,\\s*([\\d]+)%\\s*\\)/.exec(bgHsl);
        const l=m?parseInt(m[3],10):50; return l>55?'#222':'#fff';
      }

      // Build graph
      const graph = new Graph({ type: "undirected" });
      const seen = new Set();
      for(const u of DATA.users){
        if(seen.has(u.id)) continue; seen.add(u.id);
        const col = colorForNode(u.id);
        graph.addNode(u.id, {
          label: u.id,
          size: 3 + Math.min(6, (u.ropes ? u.ropes.length : 0)),
          color: col,
          labelColor: labelColor(col),
          x: Math.random(), y: Math.random()
        });
      }
      const eSeen = new Set();
      for(const e of DATA.traits){
        if(eSeen.has(e.id)) continue; eSeen.add(e.id);
        if(!graph.hasNode(e.a)){ const col=colorForNode(e.a); graph.addNode(e.a,{label:e.a,size:3,color:col,labelColor:labelColor(col),x:Math.random(),y:Math.random()}); }
        if(!graph.hasNode(e.b)){ const col=colorForNode(e.b); graph.addNode(e.b,{label:e.b,size:3,color:col,labelColor:labelColor(col),x:Math.random(),y:Math.random()}); }
        graph.addEdgeWithKey(e.id, e.a, e.b, {
          size: 1 + Math.min(4, (e.weight||1)),
          color: colorForTraitCode(e.trait_code),
          trait_code: e.trait_code,
          trait_id: e.trait_id
        });
      }

      // Circular layout (no external module)
      const order = graph.order;
      const nodes = graph.nodes();
      const twoPI = Math.PI * 2;
      const R = 100; // initial radius; Sigma will scale to viewport
      for (let i=0;i<order;i++){
        const a = (i / order) * twoPI;
        graph.setNodeAttribute(nodes[i], 'x', Math.cos(a) * R);
        graph.setNodeAttribute(nodes[i], 'y', Math.sin(a) * R);
      }

      // Ensure container has size
      const container = document.getElementById('container');
      const styles = getComputedStyle(container);
      log('container size', styles.width, styles.height);

      // Render
      if (!SigmaCtor) throw new Error('Sigma constructor missing');
      const renderer = new SigmaCtor(graph, container, {
        renderLabels: true,
        labelDensity: 0.85,
        labelSize: 10,
        labelColor: { color: 'data(labelColor)' }
      });

      // HUD
      document.getElementById('ncount').textContent = String(graph.order);
      document.getElementById('ecount').textContent = String(graph.size);

      // Interactions
      renderer.on('enterNode', ({node}) => {
        const neighbors = new Set(graph.neighbors(node));
        graph.forEachNode(n => graph.setNodeAttribute(n, 'zIndex', neighbors.has(n) || n===node ? 1 : 0));
        renderer.refresh();
      });
      renderer.on('leaveNode', () => {
        graph.forEachNode(n => graph.removeNodeAttribute(n, 'zIndex'));
        renderer.refresh();
      });

      log('OK: Sigma started. nodes=', graph.order, 'edges=', graph.size);
    } catch (err) {
      diagEl.textContent += 'ERROR: ' + (err && err.message ? err.message : String(err)) + '\\n';
      console.error(err);
    }
  </script>
</body>
</html>