<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>RopeDB Visualizer</title>
<style>
  *{box-sizing:border-box}
  html,body{margin:0;height:100vh;scrollbar-gutter:stable both-edges}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:grid;grid-template-columns:60% 40%;grid-template-rows:60% 40%;
    gap:10px;background:#f5f5f5;padding:10px
  }
  #graph,#search,#legend,#info{background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);overflow:hidden}
  #graph{grid-column:1;grid-row:1;overflow:hidden;overscroll-behavior:contain}
  #search{grid-column:2;grid-row:1;padding:16px}
  #legend{grid-column:1;grid-row:2;padding:16px}
  #info{grid-column:2;grid-row:2;padding:16px}
  #f{width:100%;height:100%;border:0;overflow:hidden;display:block}
  .sec h3{margin:0 0 10px 0;font-size:14px;color:#333}
  .row{margin-bottom:12px}
  input[type=text]{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:13px}
  button{margin-top:6px;width:100%;padding:10px;border:0;border-radius:8px;cursor:pointer;background:#2f6fed;color:#fff;font-weight:600}
  button.green{background:#28a745}
  .legend-item{display:flex;align-items:center;margin-bottom:6px}
  .legend-color{width:16px;height:16px;border-radius:3px;margin-right:8px}
  .kv{font-size:12px;color:#555}.kv b{color:#222}.muted{color:#888;font-size:12px}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
  <section id="graph"><iframe id="f" src="graph_frame.html" scrolling="no"></iframe></section>

<section id="search" style="max-height: 90vh; overflow-y: auto; padding-right: 8px;">
  <div class="sec">
    <h3>üîç Address</h3>
    <div class="row"><input id="addr" type="text" placeholder="0x1234..."/></div>
    <button id="addrBtn">Search</button>
  </div>
  <div class="sec" style="margin-top:14px">
    <h3>üè∑ Trait</h3>
    <div class="row"><input id="trait" type="text" placeholder="TraitApple or 100"/></div>
    <button id="traitBtn">Search</button>
  </div>
  <div class="sec" style="margin-top:14px">
    <h3>üßµ Rope</h3>
    <div class="row"><input id="rope" type="text" placeholder="Rope ID"/></div>
    <button id="ropeBtn">Search</button>
  </div>
  <button id="defBtn" class="green" style="margin-top:14px">üè† Default</button>
</section>


  <section id="legend">
    <div class="sec"><h3>üé® Trait Colors</h3><div id="traitLegend"><div class="legend-item"><div class="legend-color" style="background:hsl(340, 65%, 40%)"></div><span>TraitBravo</span><span style="margin-left:auto;color:#888;font-size:11px">2</span></div><div class="legend-item"><div class="legend-color" style="background:hsl(240, 65%, 40%)"></div><span>TraitCharlie</span><span style="margin-left:auto;color:#888;font-size:11px">2</span></div><div class="legend-item"><div class="legend-color" style="background:hsl(80, 65%, 40%)"></div><span>TraitApple</span><span style="margin-left:auto;color:#888;font-size:11px">5</span></div></div></div>
    <div class="sec" style="margin-top:10px"><h3>üßµ Rope Colors</h3><div id="ropeLegend"><div class="legend-item"><div class="legend-color" style="background:hsl(312, 60%, 50%)"></div><span>Rope 3</span><span style="margin-left:auto;color:#888;font-size:11px">2</span></div><div class="legend-item"><div class="legend-color" style="background:hsl(41, 70%, 35%)"></div><span>Rope 4</span><span style="margin-left:auto;color:#888;font-size:11px">1</span></div><div class="legend-item"><div class="legend-color" style="background:hsl(134, 70%, 40%)"></div><span>Rope 1</span><span style="margin-left:auto;color:#888;font-size:11px">3</span></div><div class="legend-item"><div class="legend-color" style="background:hsl(223, 80%, 45%)"></div><span>Rope 2</span><span style="margin-left:auto;color:#888;font-size:11px">2</span></div></div></div>
  </section>

  <section id="info">
    <div class="sec">
      <h3>‚ÑπÔ∏è Info</h3>
      <div id="stat" class="kv">
        Nodes: <b id="sn">0</b> | Edges: <b id="se">0</b><br/>
        Type: <b id="st">-</b><br/>
        Start: <span id="ss" class="mono muted">-</span>
      </div>
    </div>
    <div class="sec" style="margin-top:10px">
      <h3>Node</h3>
      <div id="nodeBox" class="kv muted">Hover a node‚Ä¶</div>
    </div>
    <div class="sec" style="margin-top:10px">
      <h3>Edge</h3>
      <div id="edgeBox" class="kv muted">Hover an edge‚Ä¶</div>
    </div>
  </section>

<script>
const INITIAL = {"meta":{"generatedAt":1756045545,"nodeCount":8,"edgeCount":9,"graphType":"default","startNode":"0x0000000000000000000000000000000000000001"},"nodes":[{"id":"0x000000000000000000000000000000000000000a","label":"0x00000000...","color":"hsl(223, 80%, 45%)","size":8,"ropeId":2,"ropeName":"Rope 2","traits":[{"traitCode":200,"traitName":"TraitBravo","partner":"0x0000000000000000000000000000000000000004","traitId":9},{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000006","traitId":10},{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000002","traitId":11}]},{"id":"0x0000000000000000000000000000000000000004","label":"0x00000000...","color":"hsl(223, 80%, 45%)","size":8,"ropeId":2,"ropeName":"Rope 2","traits":[{"traitCode":200,"traitName":"TraitBravo","partner":"0x0000000000000000000000000000000000000003","traitId":3},{"traitCode":300,"traitName":"TraitCharlie","partner":"0x0000000000000000000000000000000000000003","traitId":8},{"traitCode":200,"traitName":"TraitBravo","partner":"0x000000000000000000000000000000000000000a","traitId":9}]},{"id":"0x0000000000000000000000000000000000000005","label":"0x00000000...","color":"hsl(312, 60%, 50%)","size":7,"ropeId":3,"ropeName":"Rope 3","traits":[{"traitCode":300,"traitName":"TraitCharlie","partner":"0x0000000000000000000000000000000000000003","traitId":4},{"traitCode":300,"traitName":"TraitCharlie","partner":"0x0000000000000000000000000000000000000006","traitId":5}]},{"id":"0x0000000000000000000000000000000000000007","label":"0x00000000...","color":"hsl(41, 70%, 35%)","size":7,"ropeId":4,"ropeName":"Rope 4","traits":[{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000008","traitId":6},{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000003","traitId":12}]},{"id":"0x0000000000000000000000000000000000000006","label":"0x00000000...","color":"hsl(312, 60%, 50%)","size":7,"ropeId":3,"ropeName":"Rope 3","traits":[{"traitCode":300,"traitName":"TraitCharlie","partner":"0x0000000000000000000000000000000000000005","traitId":5},{"traitCode":100,"traitName":"TraitApple","partner":"0x000000000000000000000000000000000000000a","traitId":10}]},{"id":"0x0000000000000000000000000000000000000001","label":"0x00000000...","color":"hsl(134, 70%, 40%)","size":6,"ropeId":1,"ropeName":"Rope 1","traits":[{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000002","traitId":1}]},{"id":"0x0000000000000000000000000000000000000002","label":"0x00000000...","color":"hsl(134, 70%, 40%)","size":8,"ropeId":1,"ropeName":"Rope 1","traits":[{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000001","traitId":1},{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000003","traitId":2},{"traitCode":100,"traitName":"TraitApple","partner":"0x000000000000000000000000000000000000000a","traitId":11}]},{"id":"0x0000000000000000000000000000000000000003","label":"0x00000000...","color":"hsl(134, 70%, 40%)","size":10,"ropeId":1,"ropeName":"Rope 1","traits":[{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000002","traitId":2},{"traitCode":200,"traitName":"TraitBravo","partner":"0x0000000000000000000000000000000000000004","traitId":3},{"traitCode":300,"traitName":"TraitCharlie","partner":"0x0000000000000000000000000000000000000005","traitId":4},{"traitCode":300,"traitName":"TraitCharlie","partner":"0x0000000000000000000000000000000000000004","traitId":8},{"traitCode":100,"traitName":"TraitApple","partner":"0x0000000000000000000000000000000000000007","traitId":12}]}],"edges":[{"id":"e:0x0000000000000000000000000000000000000003|0x0000000000000000000000000000000000000004|200|3","source":"0x0000000000000000000000000000000000000003","target":"0x0000000000000000000000000000000000000004","color":"hsl(340, 65%, 40%)","weight":1,"traitCode":200,"traitName":"TraitBravo","traitId":3,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000003|0x0000000000000000000000000000000000000004|300|8","source":"0x0000000000000000000000000000000000000003","target":"0x0000000000000000000000000000000000000004","color":"hsl(240, 65%, 40%)","weight":1,"traitCode":300,"traitName":"TraitCharlie","traitId":8,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000004|0x000000000000000000000000000000000000000a|200|9","source":"0x0000000000000000000000000000000000000004","target":"0x000000000000000000000000000000000000000a","color":"hsl(340, 65%, 40%)","weight":1,"traitCode":200,"traitName":"TraitBravo","traitId":9,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000002|0x000000000000000000000000000000000000000a|100|11","source":"0x0000000000000000000000000000000000000002","target":"0x000000000000000000000000000000000000000a","color":"hsl(80, 65%, 40%)","weight":1,"traitCode":100,"traitName":"TraitApple","traitId":11,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000002|0x0000000000000000000000000000000000000003|100|2","source":"0x0000000000000000000000000000000000000002","target":"0x0000000000000000000000000000000000000003","color":"hsl(80, 65%, 40%)","weight":1,"traitCode":100,"traitName":"TraitApple","traitId":2,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000003|0x0000000000000000000000000000000000000005|300|4","source":"0x0000000000000000000000000000000000000003","target":"0x0000000000000000000000000000000000000005","color":"hsl(240, 65%, 40%)","weight":1,"traitCode":300,"traitName":"TraitCharlie","traitId":4,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000003|0x0000000000000000000000000000000000000007|100|12","source":"0x0000000000000000000000000000000000000003","target":"0x0000000000000000000000000000000000000007","color":"hsl(80, 65%, 40%)","weight":1,"traitCode":100,"traitName":"TraitApple","traitId":12,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000006|0x000000000000000000000000000000000000000a|100|10","source":"0x0000000000000000000000000000000000000006","target":"0x000000000000000000000000000000000000000a","color":"hsl(80, 65%, 40%)","weight":1,"traitCode":100,"traitName":"TraitApple","traitId":10,"lastSeen":1756045545},{"id":"e:0x0000000000000000000000000000000000000001|0x0000000000000000000000000000000000000002|100|1","source":"0x0000000000000000000000000000000000000001","target":"0x0000000000000000000000000000000000000002","color":"hsl(80, 65%, 40%)","weight":1,"traitCode":100,"traitName":"TraitApple","traitId":1,"lastSeen":1756045545}],"legend":{"traits":{"100":{"color":"hsl(80, 65%, 40%)","name":"TraitApple","count":5},"200":{"color":"hsl(340, 65%, 40%)","name":"TraitBravo","count":2},"300":{"color":"hsl(240, 65%, 40%)","name":"TraitCharlie","count":2}},"ropes":{"1":{"color":"hsl(134, 70%, 40%)","name":"Rope 1","count":3},"2":{"color":"hsl(223, 80%, 45%)","name":"Rope 2","count":2},"3":{"color":"hsl(312, 60%, 50%)","name":"Rope 3","count":2},"4":{"color":"hsl(41, 70%, 35%)","name":"Rope 4","count":1}}}};
const f = document.getElementById('f');
const sn=document.getElementById('sn'), se=document.getElementById('se'), st=document.getElementById('st'), ss=document.getElementById('ss');
const nodeBox=document.getElementById('nodeBox'), edgeBox=document.getElementById('edgeBox');

function syncStats(g){
  sn.textContent = String(g.meta?.nodeCount || (g.nodes?g.nodes.length:0) || 0);
  se.textContent = String(g.meta?.edgeCount || (g.edges?g.edges.length:0) || 0);
  st.textContent = g.meta?.graphType || '-';
  ss.textContent = g.meta?.startNode || '-';
}
syncStats(INITIAL);

window.addEventListener('message', (ev)=>{
  const msg = ev.data||{};
  if (msg.type==='child-mounted'){
    f.contentWindow.postMessage({type:'load-graph', payload: INITIAL}, '*');
  } else if (msg.type==='child-ready'){
    // ok Ïó¨Î∂ÄÎßå ÌôïÏù∏
  } else if (msg.type==='node-hover'){
    if (!msg.payload){ nodeBox.textContent='Hover a node‚Ä¶'; nodeBox.classList.add('muted'); return; }
    nodeBox.classList.remove('muted');
    nodeBox.innerHTML = 'ID: <span class="mono">'+msg.payload.id+'</span><br/>Label: <b>'+(msg.payload.label||'')+'</b>';
  } else if (msg.type==='edge-hover'){
    if (!msg.payload){ edgeBox.textContent='Hover an edge‚Ä¶'; edgeBox.classList.add('muted'); return; }
    edgeBox.classList.remove('muted');
    const p = msg.payload;
    edgeBox.innerHTML = 'Trait: <b>'+(p.traitName||('code '+p.traitCode))+'</b> <span class="mono">#'+(p.traitId||0)+'</span>';
  } else if (msg.type==='node-click'){
    const id = msg.payload && msg.payload.id;
    if (id){ f.contentWindow.postMessage({type:'expand', payload:{vertexId:id}}, '*'); }
  } else if (msg.type==='expand-result'){
    const inc = msg.payload; if (!inc) return;
    const merged = mergeGraph(INITIAL, inc);
    Object.assign(INITIAL, merged);
    syncStats(INITIAL);
    f.contentWindow.postMessage({type:'apply-graph', payload: INITIAL}, '*');
  }
});

function mergeGraph(base, inc){
  const nm = new Map(), em = new Map();
  (base.nodes||[]).forEach(n=>nm.set(n.id,n));
  (inc.nodes||[]).forEach(n=>nm.set(n.id,n));
  (base.edges||[]).forEach(e=>em.set(e.id,e));
  (inc.edges||[]).forEach(e=>em.set(e.id,e));
  const nodes=[...nm.values()], edges=[...em.values()];
  return { meta:{generatedAt:Math.floor(Date.now()/1000),graphType:'convolution',
           startNode: base.meta?.startNode || inc.meta?.startNode || '',
           nodeCount:nodes.length,edgeCount:edges.length}, nodes, edges,
           legend: base.legend || inc.legend || {traits:{},ropes:{}} };
}

// Í≤ÄÏÉâ(ÌõÖ ÏûêÎ¶¨Îßå)
document.getElementById('defBtn').onclick = ()=>{ f.contentWindow.postMessage({type:'load-graph', payload: INITIAL}, '*'); syncStats(INITIAL); };
document.getElementById('addrBtn').onclick = ()=>{
  const v=(document.getElementById('addr').value||'').trim();
  if (!v) return alert('enter address');
  f.contentWindow.postMessage({type:'expand', payload:{vertexId:v}}, '*');
};
document.getElementById('traitBtn').onclick = ()=>{ alert('Trait search: hook to FetchGraphByTraitCode later'); };
document.getElementById('ropeBtn').onclick = ()=>{ alert('Rope search: hook to FetchGraphByRopeID later'); };
</script>
</body></html>